#!/usr/bin/env bash

#
# The script generates .h files for external dependencies,
#   evercrypt and l0core (from DICE*) so far
# The generated .h files are used to generate Rust bindings
#   using the rust bindgen tool
#

set -e
set -x

# chdir to the current directory
unset CDPATH
cd "$( dirname "${BASH_SOURCE[0]}" )"

if  [[ -z "$PULSE_HOME" ]] ; then
    PULSE_HOME=$(realpath $(pwd)/../../)
fi

# regenerate EverCrypt*.h and L0Core.h
make -j -f c.Makefile
cp $PULSE_HOME/share/pulse/examples/dice/external/c/hacl/EverCrypt_Base.h _output/
echo "// This file is generated by gen-rust-bindings.sh" > _output/bindings.h
for f in _output/EverCrypt_*.h ; do echo '#include "'$(basename $f)'"' ; done >> _output/bindings.h
echo '#include "L0Core.h"' >> _output/bindings.h
